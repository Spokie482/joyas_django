{% extends 'tienda/base.html' %}

{% block title %}Panel de Control{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
    }

    h1 { color: #2c3e50; font-weight: 300; margin-bottom: 30px; letter-spacing: 2px; }

    /* TARJETAS DE MÉTRICAS (KPIs) */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .kpi-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.3s;
    }
    .kpi-card:hover { transform: translateY(-5px); }

    .kpi-info h3 { margin: 0; color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; }
    .kpi-info p { margin: 5px 0 0 0; color: #2c3e50; font-size: 1.8rem; font-weight: bold; }
    
    .kpi-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }

    /* SECCIÓN DE GRÁFICOS */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(15px);
        border-radius: 25px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    
    .chart-title { text-align: center; color: #2c3e50; margin-bottom: 20px; font-weight: 600; }

    /* TABLA RECIENTE */
    .recent-orders {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        border-radius: 25px;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.9);
    }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 15px; color: #7f8c8d; border-bottom: 2px solid rgba(0,0,0,0.05); }
    td { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); color: #2c3e50; }
    
    .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h1>Panel de Control</h1>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-info">
                <h3>Satisfacción</h3>
                <p>{{ promedio_calidad }} <span style="font-size: 1rem; color: #f1c40f;">★</span></p>
            </div>
            <div class="kpi-icon" style="color: #f1c40f;"><i class="ri-star-smile-line"></i></div>
        </div>

        <div class="kpi-card">
            <div class="kpi-info">
                <h3>Pedidos</h3>
                <p>{{ total_ordenes }}</p>
            </div>
            <div class="kpi-icon" style="color: #2980b9;"><i class="ri-shopping-bag-3-line"></i></div>
        </div>

        <div class="kpi-card">
            <div class="kpi-info">
                <h3>Usuarios</h3>
                <p>{{ total_usuarios }}</p>
            </div>
            <div class="kpi-icon" style="color: #8e44ad;"><i class="ri-group-line"></i></div>
        </div>

        <div class="kpi-card" style="border-color: {% if low_stock_count > 0 %}#e74c3c{% else %}#fff{% endif %};">
            <div class="kpi-info">
                <h3>Stock Bajo</h3>
                <p style="color: {% if low_stock_count > 0 %}#c0392b{% else %}#2c3e50{% endif %};">{{ low_stock_count }}</p>
            </div>
            <div class="kpi-icon" style="color: #e67e22;"><i class="ri-alert-line"></i></div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">Estado de los Pedidos</div>
            <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">Top 5 Productos Vendidos</div>
            <canvas id="productsChart"></canvas>
        </div>
    </div>

    <div style="display: flex; gap: 30px; flex-wrap: wrap;">

    <div class="recent-orders" style="flex: 2; min-width: 400px;">
        <div class="chart-title" style="text-align: left;">Últimas Ventas</div>
            <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Estado</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in ordenes_recientes %}
                <tr>
                    <td>#{{ orden.id }}</td>
                    <td>{{ orden.usuario.username }}</td>
                    <td>
                        <span class="status-dot" style="background: #3498db;"></span>
                        {{ orden.get_estado_display }}
                    </td>
                    <td><strong>${{ orden.total }}</strong></td>
                </tr>
                {% empty %}
                <tr><td colspan="4">Sin ventas recientes.</td></tr>
                {% endfor %}
            </tbody>
            </table>
        </div>

        <div class="recent-orders" style="flex: 1; min-width: 300px;">
            <div class="chart-title" style="text-align: left;">Últimas Opiniones</div>

            {% for review in ultimas_reviews %}
            <div style="background: rgba(255,255,255,0.5); padding: 15px; border-radius: 15px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <strong style="font-size: 0.9rem;">{{ review.usuario.username }}</strong>
                    <span style="color: #f1c40f;">★ {{ review.calificacion }}</span>
                </div>
                <p style="font-size: 0.85rem; color: #7f8c8d; margin: 0; font-style: italic;">"{{ review.comentario|truncatechars:40 }}"</p>
                <small style="color: #bdc3c7; font-size: 0.7rem;">en {{ review.producto.nombre }}</small>
            </div>
            {% empty %}
            <p style="color: #95a5a6; padding: 20px;">No hay opiniones aún.</p>
            {% endfor %}
        </div>
    </div>

    <div class="recent-orders">
        <div class="chart-title" style="text-align: left;">Últimas Ventas</div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for orden in ordenes_recientes %}
                <tr>
                    <td>#{{ orden.id }}</td>
                    <td>{{ orden.usuario.username }}</td>
                    <td>{{ orden.fecha|date:"d M Y" }}</td>
                    <td>
                        <span class="status-dot" 
                              style="background: {% if orden.estado == 'PENDIENTE' %}#f1c40f{% elif orden.estado == 'ENTREGADO' %}#27ae60{% else %}#3498db{% endif %};">
                        </span>
                        {{ orden.get_estado_display }}
                    </td>
                    <td><strong>${{ orden.total }}</strong></td>
                </tr>
                {% empty %}
                <tr><td colspan="5" style="text-align:center;">No hay ventas recientes.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
    // 1. Gráfico de Dona (Estados)
    const ctxStatus = document.getElementById('statusChart').getContext('2d');
    new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: JSON.parse('{{ labels_estados|safe }}'),
            datasets: [{
                data: JSON.parse('{{ data_estados|safe }}'),
                backgroundColor: ['#f1c40f', '#2ecc71', '#3498db', '#e74c3c', '#9b59b6'],
                borderWidth: 0
            }]
        },
        options: { responsive: true }
    });

    // 2. Gráfico de Barras (Top Productos)
    const ctxProducts = document.getElementById('productsChart').getContext('2d');
    new Chart(ctxProducts, {
        type: 'bar',
        data: {
            labels: JSON.parse('{{ labels_top|safe }}'),
            datasets: [{
                label: 'Unidades Vendidas',
                data: JSON.parse('{{ data_top|safe }}'),
                backgroundColor: '#e1b12c',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}