{% extends 'tienda/base.html' %}

{% block title %}Tu Bolsa{% endblock %}

{% block extra_css %}
<style>
    .cart-wrapper {
        max-width: 1100px;
        margin: 40px auto;
        display: flex;
        gap: 30px;
        flex-wrap: wrap;
    }

    /* COLUMNA IZQUIERDA: LISTA DE PRODUCTOS */
    .cart-items-col {
        flex: 2;
        min-width: 300px;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    h1 { color: #2c3e50; font-weight: 300; margin-top: 0; }

    /* Estilo de cada item en el carrito */
    .cart-item {
        display: flex;
        align-items: center;
        padding: 20px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .cart-item:last-child { border-bottom: none; }

    .item-img {
        width: 80px;
        height: 80px;
        border-radius: 15px;
        object-fit: cover;
        margin-right: 20px;
        background: #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .item-details { flex: 1; }
    
    .item-name {
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .item-cat { font-size: 0.85rem; color: #95a5a6; }

    /* Controles de cantidad */
    .qty-control {
        display: flex;
        align-items: center;
        background: #fff;
        border-radius: 50px;
        padding: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-right: 20px;
    }
    
    .btn-qty {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: transparent;
        cursor: pointer;
        color: #2c3e50;
        font-weight: bold;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }
    .btn-qty:hover { background: #ecf0f1; }
    
    .qty-number { padding: 0 10px; font-weight: 600; font-size: 0.9rem; }

    .item-price {
        font-size: 1.1rem;
        color: #2c3e50;
        font-weight: bold;
        min-width: 80px;
        text-align: right;
    }

    .btn-delete {
        color: #e74c3c;
        background: none;
        border: none;
        margin-left: 15px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: 0.3s;
        text-decoration: none;
    }
    .btn-delete:hover { transform: scale(1.2); }


    /* COLUMNA DERECHA: RESUMEN */
    .cart-summary-col {
        flex: 1;
        min-width: 280px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        color: #7f8c8d;
    }
    .summary-total {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px dashed rgba(0,0,0,0.1);
        font-size: 1.5rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .btn-checkout {
        display: block;
        width: 100%;
        padding: 15px;
        background: #2c3e50;
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 50px;
        font-weight: 600;
        margin-top: 25px;
        box-shadow: 0 10px 20px rgba(44, 62, 80, 0.2);
        transition: 0.3s;
    }
    .btn-checkout:hover {
        background: #34495e;
        transform: translateY(-2px);
    }

    /* BARRA DE ENV√çO GRATIS */
    .shipping-progress {
        background: #ecf0f1;
        height: 8px;
        border-radius: 4px;
        margin: 15px 0;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #f1c40f, #e1b12c);
        width: 0%; /* Se calcula con JS o Style inline */
        transition: width 1s ease;
    }

</style>
{% endblock %}

{% block content %}
<div class="cart-wrapper">

    <div class="cart-items-col">
        <div class="glass-card">
            
            
            {% if request.session.carrito %}
                
                <h1>Estas a un paso de terminar la compra!!!</h1>

                <div id="timer-box" style="display: none; background: rgba(231, 76, 60, 0.1); color: #c0392b; padding: 10px; border-radius: 10px; margin-bottom: 20px; text-align: center; border: 1px solid rgba(231, 76, 60, 0.3);">
                    <i class="ri-timer-flash-line"></i> Tu carrito expirar√° en: 
                    <span id="countdown" style="font-weight: bold; font-size: 1.1rem;">--:--:--</span>
                </div>
                
                {% widthratio total 15000 100 as porcentaje %}
                <div style="margin-bottom: 30px;">
                    {% if total < limite_envio %}
                        <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 5px;">
                            ¬°Te faltan <strong>${{ falta_envio }}</strong> para env√≠o gratis! üöö
                        </p>
                        <div class="shipping-progress">
                            <div class="progress-fill" style="width: {{ porcentaje_envio }}%;"></div>
                        </div>
                    {% else %}
                        <p style="color: #27ae60; font-weight: bold;">¬°Genial! Tienes Env√≠o Gratis üéâ</p>
                        <div class="shipping-progress">
                            <div class="progress-fill" style="width: 100%; background: #27ae60;"></div>
                        </div>
                    {% endif %}
                </div>

                {% for key, item in request.session.carrito.items %}
                <div class="cart-item">
                    {% if item.imagen %}
                        <img src="{{ item.imagen }}" class="item-img">
                    {% else %}
                        <div class="item-img" style="display:flex; align-items:center; justify-content:center; color:#ccc; font-size:0.8rem;">Sin Foto</div>
                    {% endif %}
                    
                    <div class="item-details">
                        <div class="item-name">{{ item.nombre }}</div>
                        <div class="item-cat">Ref: {{ item.producto_id }}</div>
                    </div>

                    <div class="qty-control">
                        <a href="{% url 'restar_carrito' item.producto_id %}{% if item.variante_id %}?variante={{ item.variante_id }}{% endif %}" class="btn-qty">-</a>
                        
                        <span class="qty-number">{{ item.cantidad }}</span>
                        
                        <a href="{% url 'agregar_carrito' item.producto_id %}{% if item.variante_id %}?variante={{ item.variante_id }}{% endif %}" class="btn-qty">+</a>

                    </div>

                    <div class="item-price">
                        ${{ item.precio }}
                    </div>

                    <a href="{% url 'eliminar_carrito' item.producto_id %}" class="btn-delete" title="Eliminar">
                        <i class="ri-delete-bin-line"></i>
                    </a>
                </div>
                {% endfor %}

                <div style="margin-top: 20px;">
                    <a href="{% url 'catalogo' %}" style="text-decoration: none; color: #7f8c8d; font-size: 0.9rem;">
                        <i class="ri-arrow-left-line"></i> Seguir comprando
                    </a>
                    <a href="{% url 'limpiar_carrito' %}" style="float: right; text-decoration: none; color: #e74c3c; font-size: 0.9rem;">
                        Vaciar carrito
                    </a>
                </div>

            {% else %}
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 4rem; color: #ecf0f1; margin-bottom: 20px;"><i class="ri-shopping-cart-2-line"></i></div>
                    <h3 style="color: #95a5a6;">Tu bolsa est√° vac√≠a</h3>
                    <a href="{% url 'catalogo' %}" class="btn-checkout" style="max-width: 200px; margin: 20px auto;">Ir a la tienda</a>
                </div>
            {% endif %}
        </div>
    </div>

    {% if request.session.carrito %}
    <div class="cart-summary-col">
        <div class="glass-card">
            <h3 style="color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-top:0;">Resumen</h3>
            
            <div class="summary-row">
                <span>Subtotal</span>
                <span>${{ total }}</span>
            </div>
            <div class="summary-row">
                <span>Env√≠o</span>
                {% if total >= limite_envio %}
                    <span style="color: #27ae60; font-weight: bold;">Gratis</span>
                {% else %}
                    <span> $5000.0</span>
                {% endif %}
            </div>
            <div class="summary-row">
                <span>Impuestos</span>
                <span>$0.00</span>
            </div>

            <form action="{% url 'aplicar_cupon' %}" method="POST" style="margin-top: 20px; display: flex; gap: 5px;">
                {% csrf_token %}
                <input type="text" name="codigo_cupon" placeholder="C√≥digo cup√≥n" value="{{ nombre_cupon|default:'' }}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                <button type="submit" style="background: #2c3e50; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer;">
                    <i class="ri-check-line"></i>
                </button>
            </form>
            
            {% if messages %}
                {% for message in messages %}
                    {% if "cup√≥n" in message.message|lower %}
                    <div style="font-size: 0.8rem; margin-top: 5px; color: {% if message.tags == 'success' %}#27ae60{% else %}#c0392b{% endif %};">
                        {{ message }}
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if descuento > 0 %}
            <div class="summary-row" style="color: #27ae60; font-weight: bold; margin-top: 10px;">
                <span>Descuento ({{ nombre_cupon }})</span>
                <span>- ${{ descuento }}</span>
            </div>
            {% endif %}

            <div class="summary-total">
                <span>Total</span>
                <span>${{ total_final }}</span>
            </div>

            <a href="{% url 'finalizar_compra' %}" class="btn-checkout">
                FINALIZAR COMPRA <i class="ri-arrow-right-line"></i>
            </a>
            
            <div style="margin-top: 20px; text-align: center; color: #bdc3c7; font-size: 1.5rem; display: flex; justify-content: center; gap: 15px;">
                <i class="ri-visa-line"></i>
                <i class="ri-mastercard-line"></i>
                <i class="ri-paypal-line"></i>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtenemos los segundos desde Django (Backend)
        let timeLeft = {{ segundos_restantes|default:0 }};
        
        const timerBox = document.getElementById('timer-box');
        const display = document.getElementById('countdown');
        
        if (timeLeft > 0) {
            timerBox.style.display = 'block';
            
            const interval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    display.innerHTML = "00:00:00";
                    // Recargar para que el backend vac√≠e el carrito
                    window.location.reload(); 
                } else {
                    timeLeft--;
                    
                    const h = Math.floor(timeLeft / 3600);
                    const m = Math.floor((timeLeft % 3600) / 60);
                    const s = Math.floor(timeLeft % 60);
                    
                    // Formato HH:MM:SS
                    display.textContent = 
                        `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
    });
</script>
{% endblock %}